// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User roles for access control
enum Role {
  ADMIN
  USER
}

// User model for app authentication
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  accounts Account[]
  sessions Session[]
  invitesSent Invite[] @relation("InviteSender")

  @@index([email])
}

// Invite model for invite-only registration
model Invite {
  id          String    @id @default(cuid())
  email       String    @unique
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  // Who sent the invite
  invitedById String
  invitedBy   User      @relation("InviteSender", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
}

// Session model for authentication
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
}

// Central account model - each card on the dashboard is one account
// Now linked to User for multi-tenancy (each user has their own isolated accounts)
model Account {
  id        String   @id @default(cuid())
  platform  String   // "twitter", "youtube", or "instagram"
  name      String   @default("") // Optional display name for the account
  order     Int      @default(0) // Display order on dashboard
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to User (for multi-tenancy)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  twitterCredentials    TwitterCredentials?
  twitterConfig         TwitterConfiguration?
  youtubeCredentials    YouTubeCredentials?
  youtubeConfig         YouTubeConfiguration?
  instagramCredentials  InstagramCredentials?
  instagramConfig       InstagramConfiguration?
  redditCredentials     RedditCredentials?
  redditConfig          RedditConfiguration?
  openRouterCredentials OpenRouterCredentials?
  logs                  Log[]
  tweetInteractions     TweetInteraction[]
  youtubeCommentInteractions YouTubeCommentInteraction[]
  redditInteractions    RedditInteraction[]

  @@index([platform])
  @@index([order])
  @@index([userId])
}

model TwitterConfiguration {
  id                String   @id @default(cuid())
  enabled           Boolean  @default(false) // Whether automation is active
  searchTerm        String   @default("")
  schedule          String   @default("every_hour") // every_5_min, every_10_min, every_30_min, every_hour, every_3_hours, every_6_hours
  minimumLikesCount Int      @default(20) // Minimum likes filter for search
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relation to Account
  accountId         String   @unique
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model TwitterCredentials {
  id          String   @id @default(cuid())
  // OAuth 2.0 credentials (from Developer Portal)
  clientId    String   @default("")
  clientSecret String  @default("")
  // Rapid API
  rapidApiKey String   @default("")
  // OAuth 1.0a credentials (from Developer Portal) - kept for future use
  apiKey      String   @default("")
  apiSecret   String   @default("")
  bearerToken String   @default("")
  // User OAuth tokens (obtained after user login)
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?
  // Connected user info
  userId            String?
  username          String?
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to Account
  accountId   String   @unique
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model YouTubeConfiguration {
  id                String   @id @default(cuid())
  enabled           Boolean  @default(false) // Whether automation is active
  schedule          String   @default("every_hour") // every_5_min, every_10_min, every_30_min, every_hour, every_3_hours, every_6_hours
  minimumLikesCount Int      @default(5) // Minimum likes filter for comments
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relation to Account
  accountId  String   @unique
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model YouTubeCredentials {
  id          String   @id @default(cuid())
  // API Key (for reading public data like comments)
  apiKey      String   @default("")
  // OAuth 2.0 credentials (from Google Cloud Console - for replying to comments)
  clientId    String   @default("")
  clientSecret String  @default("")
  // User OAuth tokens (obtained after user login)
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?
  // Connected user info (channel info)
  channelId         String?
  channelTitle      String?
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to Account
  accountId   String   @unique
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model InstagramConfiguration {
  id         String   @id @default(cuid())
  schedule   String   @default("every_hour") // every_5_min, every_10_min, every_30_min, every_hour, every_3_hours, every_6_hours
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relation to Account
  accountId  String   @unique
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model InstagramCredentials {
  id          String   @id @default(cuid())
  // Meta App credentials (from Meta Developer Portal)
  appId       String   @default("")
  appSecret   String   @default("")
  // User OAuth tokens (obtained after user login via Facebook Login)
  accessToken       String?
  tokenExpiresAt    DateTime?
  // Connected Instagram Business/Creator account info
  instagramAccountId    String?  // Instagram-scoped user ID
  instagramUsername     String?
  // Linked Facebook Page info (required for Instagram API)
  facebookPageId        String?
  facebookPageName      String?
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to Account
  accountId   String   @unique
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

// OpenRouter credentials - per account for API access
model OpenRouterCredentials {
  id           String   @id @default(cuid())
  apiKey       String   @default("")
  systemPrompt String?  // Custom system prompt for AI agents
  selectedModel String? // Selected LLM model ID
  // Style options (injected into system prompt)
  noHashtags      Boolean @default(false)
  noEmojis        Boolean @default(false)
  noCapitalization Boolean @default(false)
  badGrammar      Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relation to Account
  accountId    String   @unique
  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

// OpenRouter models - global cache of available models
model OpenRouterModel {
  id              String   @id // Use the model ID from OpenRouter (e.g., "openai/gpt-4")
  name            String   // Display name
  description     String?  // Model description
  contextLength   Int      @default(0) // Max context length
  pricing         String?  // JSON string with pricing info
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
}

// Log entries for tracking account activity
model Log {
  id        String   @id @default(cuid())
  level     String   // "info", "warning", "error", "success"
  message   String
  metadata  String?  // JSON string for additional context
  createdAt DateTime @default(now())

  // Relation to Account
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([createdAt])
  @@index([accountId, createdAt])
}

// Tweet interactions - tracks viral tweets and our responses
model TweetInteraction {
  id            String   @id @default(cuid())
  tweetId       String   // Original tweet ID from Twitter
  userTweet     String   // The original tweet content
  username      String   // Username of the original tweeter
  views         Int      @default(0)
  hearts        Int      @default(0)
  replies       Int      @default(0) // Reply count
  ourReply      String?  // Our response tweet content
  ourReplyId    String?  // Our reply tweet ID
  repliedAt     DateTime? // When we replied
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to Account
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, tweetId])
  @@index([accountId])
  @@index([createdAt])
  @@index([accountId, createdAt])
}

// YouTube comment interactions - tracks comments and our responses
model YouTubeCommentInteraction {
  id            String   @id @default(cuid())
  commentId     String   // Original comment ID from YouTube
  videoId       String   // Video the comment is on
  videoTitle    String   @default("") // Video title for display
  userComment   String   // The original comment content
  authorName    String   // Username of the commenter
  authorChannelId String @default("") // Channel ID of commenter
  likeCount     Int      @default(0)
  ourReply      String?  // Our response comment content
  ourReplyId    String?  // Our reply comment ID
  repliedAt     DateTime? // When we replied
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to Account
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, commentId])
  @@index([accountId])
  @@index([createdAt])
  @@index([accountId, createdAt])
  @@index([videoId])
}

// Reddit configuration - per account settings
model RedditConfiguration {
  id                String   @id @default(cuid())
  enabled           Boolean  @default(false) // Whether automation is active
  schedule          String   @default("every_hour") // every_5_min, every_10_min, every_30_min, every_hour, every_3_hours, every_6_hours
  keywords          String   @default("") // Comma-separated keywords to search for
  timeRange         String   @default("day") // hour, day, week, month
  minimumUpvotes    Int      @default(10) // Minimum upvotes filter for posts
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relation to Account
  accountId  String   @unique
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

// Reddit credentials - OAuth and user info
model RedditCredentials {
  id          String   @id @default(cuid())
  // Reddit App credentials (from Reddit Developer Portal)
  clientId    String   @default("")
  clientSecret String  @default("")
  // User OAuth tokens (obtained after user login)
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?
  // Connected Reddit user info
  redditUserId      String?  // Reddit's unique user ID (t2_xxxxx)
  username          String?  // Reddit username
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to Account
  accountId   String   @unique
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

// Reddit post interactions - tracks posts and our comments
model RedditInteraction {
  id            String   @id @default(cuid())
  postId        String   // Reddit post ID (t3_xxxxx format)
  subreddit     String   // Subreddit name (without r/)
  postTitle     String   // Title of the post
  postAuthor    String   // Username of the post author
  postUrl       String   @default("") // URL to the post
  upvotes       Int      @default(0)
  commentCount  Int      @default(0)
  ourComment    String?  // Our response comment content
  ourCommentId  String?  // Our comment ID
  repliedAt     DateTime? // When we replied
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to Account
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, postId])
  @@index([accountId])
  @@index([createdAt])
  @@index([accountId, createdAt])
  @@index([subreddit])
}
